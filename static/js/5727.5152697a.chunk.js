"use strict";(self.webpackChunkcity_walk_app=self.webpackChunkcity_walk_app||[]).push([[5727],{19061:(t,e,i)=>{i.d(e,{H:()=>F,b:()=>R,c:()=>z,s:()=>D});var r=i(19555),s=i(72745),n=i(55855),o=i(14556),a=i(34981),l=i(26917),h=i(90080),c=i(98720),u=i(40318),d=i(38280),f=i(62374),p=i(48020),g=i(66763),_=i(90235),m=i(80883),v=i(81449),y=i(69817),w=i(42451),x=i(95756),b=i(20123),A=i(58350),O=i(21390),E=i(64839),T=i(32307),C=i(70367),S=i(72001),M=i(66470);const D={occludedFadeFactor:.6};function R(t){const e=new T.N5,i=t.signedDistanceFieldEnabled;if(e.include(u.Q,t),e.include(l.HQ,t),t.occlusionPass)return e.include(d.I,t),e;const{vertex:s,fragment:R}=e;e.include(y.Y6),e.include(g.A,t),e.include(h.g,t),e.include(f.y),R.include(v.W),R.include(m.a),e.varyings.add("vcolor","vec4"),e.varyings.add("vtc","vec2"),e.varyings.add("vsize","vec2"),e.varyings.add("voccluded","float"),s.uniforms.add(new A.E("viewport",((t,e)=>e.camera.fullViewport)),new x.G("screenOffset",((t,e)=>(0,r.hZ)(I,2*t.screenOffset[0]*e.camera.pixelRatio,2*t.screenOffset[1]*e.camera.pixelRatio))),new x.G("anchorPosition",(t=>z(t))),new A.E("materialColor",(t=>t.color)),new O.m("materialRotation",(t=>t.rotation))),(0,w.Nz)(s),i&&(s.uniforms.add(new A.E("outlineColor",(t=>t.outlineColor))),R.uniforms.add(new A.E("outlineColor",(t=>P(t)?t.outlineColor:n.uY)),new O.m("outlineSize",(t=>P(t)?t.outlineSize:0)))),t.horizonCullingEnabled&&s.uniforms.add(new b.V("pointDistanceSphere",((t,e)=>{const i=e.camera.eye,r=t.origin;return(0,n.fA)(r[0]-i[0],r[1]-i[1],r[2]-i[2],o.$O.radius)}))),t.pixelSnappingEnabled&&s.include(c.K),t.hasScreenSizePerspective&&((0,y.pM)(s),(0,y.OH)(s)),t.debugDrawLabelBorder&&e.varyings.add("debugBorderCoords","vec4"),e.attributes.add(M.r.UV0,"vec2"),e.attributes.add(M.r.COLOR,"vec4"),e.attributes.add(M.r.SIZE,"vec2"),e.attributes.add(M.r.ROTATION,"float"),e.attributes.add(M.r.FEATUREATTRIBUTE,"vec4"),s.code.add(t.horizonCullingEnabled?E.H`bool behindHorizon(vec3 posModel) {
vec3 camToEarthCenter = pointDistanceSphere.xyz - localOrigin;
vec3 camToPos = pointDistanceSphere.xyz + posModel;
float earthRadius = pointDistanceSphere.w;
float a = dot(camToPos, camToPos);
float b = dot(camToPos, camToEarthCenter);
float c = dot(camToEarthCenter, camToEarthCenter) - earthRadius * earthRadius;
return  b > 0.0 && b < a && b * b  > a * c;
}`:E.H`bool behindHorizon(vec3 posModel) { return false; }`),s.main.add(E.H`
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      forwardObjectAndLayerIdColor();

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }

      if (behindHorizon(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }

      vec2 inputSize;
      ${(0,E.If)(t.hasScreenSizePerspective,E.H`
          inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
          vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);`,E.H`
          inputSize = size;
          vec2 screenOffsetScaled = screenOffset;`)}
      ${(0,E.If)(t.vvSize,E.H`inputSize *= vvScale(featureAttribute).xx;`)}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);
      bool visible = testHUDVisibility(posProj);
      voccluded = visible ? 0.0 : 1.0;
    `);const F=E.H`
      vec2 uv01 = floor(uv0);
      vec2 uv = uv0 - uv01;
      quadOffset.xy = (uv01 - anchorPosition) * 2.0 * combinedSize;

      ${(0,E.If)(t.hasRotation,E.H`
          float angle = radians(materialRotation + rotation);
          float cosAngle = cos(angle);
          float sinAngle = sin(angle);
          mat2 rotate = mat2(cosAngle, -sinAngle, sinAngle,  cosAngle);

          quadOffset.xy = rotate * quadOffset.xy;
        `)}

      quadOffset.xy = (quadOffset.xy + screenOffsetScaled) / viewport.zw * posProj.w;
  `,N=t.pixelSnappingEnabled?i?E.H`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:E.H`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:E.H`posProj += quadOffset;`;s.main.add(E.H`
    ${(0,E.If)(t.occlusionTestEnabled,E.H`
      if (!visible) {
        vtc = vec2(0.0);
        ${(0,E.If)(t.debugDrawLabelBorder,"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);")}
        return;
      }`)}
    ${F}
    ${t.vvColor?"vcolor = interpolateVVColor(featureAttribute.y) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

    ${(0,E.If)(t.output===a.V.ObjectAndLayerIdColor,E.H`vcolor.a = 1.0;`)}

    bool alphaDiscard = vcolor.a < ${E.H.float(_.Q)};
    ${(0,E.If)(i,`alphaDiscard = alphaDiscard && outlineColor.a < ${E.H.float(_.Q)};`)}
    if (alphaDiscard) {
      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    } else {
      ${N}
      gl_Position = posProj;
    }

    vtc = uv;

    ${(0,E.If)(t.debugDrawLabelBorder,E.H`debugBorderCoords = vec4(uv01, 1.5 / combinedSize);`)}
    vsize = inputSize;
  `),R.uniforms.add(new C.N("tex",(t=>t.texture))),t.occludedFragmentFade&&(R.uniforms.add(new C.N("depthMap",((t,e)=>e.mainDepth))),R.uniforms.add(new O.m("fadeFactor",(()=>D.occludedFadeFactor))));const B=t.debugDrawLabelBorder?E.H`(isBorder > 0.0 ? 0.0 : ${E.H.float(_.Q)})`:E.H.float(_.Q),j=t.output===a.V.Highlight,V=E.H`
    ${(0,E.If)(t.debugDrawLabelBorder,E.H`float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`)}

    ${(0,E.If)(t.sampleSignedDistanceFieldTexelCenter,E.H`
      float txSize = float(textureSize(tex, 0).x);
      float texelSize = 1.0 / txSize;

      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;`,E.H`vec2 samplePos = vtc;`)}

    ${i?E.H`
      vec4 fillPixelColor = vcolor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${B} ||
          fillPixelColor.a + outlinePixelColor.a < ${E.H.float(_.Q)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        ${(0,E.If)(!j,E.H`fragColor = vec4(compositeColor, compositeAlpha);`)}
      } else {
        if (fillAlphaFactor < ${B}) {
          discard;
        }

        ${(0,E.If)(!j,E.H`fragColor = premultiplyAlpha(fillPixelColor);`)}
      }

      // visualize SDF:
      // fragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:E.H`
          vec4 texColor = texture(tex, vtc, -0.5);
          if (texColor.a < ${B}) {
            discard;
          }
          ${(0,E.If)(!j,E.H`fragColor = texColor * premultiplyAlpha(vcolor);`)}
          `}

    ${(0,E.If)(t.occludedFragmentFade&&!j,E.H`
        float zSample = texelFetch(depthMap, ivec2(gl_FragCoord.xy), 0).x;
        if (zSample < gl_FragCoord.z) {
          fragColor *= fadeFactor;
        }
        `)}

    ${(0,E.If)(!j&&t.debugDrawLabelBorder,E.H`fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`)}
  `;switch(t.output){case a.V.Color:t.oitPass===S.Y.ColorAlpha&&(e.outputs.add("fragColor","vec4",0),e.outputs.add("fragAlpha","float",1)),R.main.add(E.H`
        ${V}
        ${(0,E.If)(t.oitPass===S.Y.FrontFace,E.H`fragColor.rgb /= fragColor.a;`)}
        ${(0,E.If)(t.oitPass===S.Y.ColorAlpha,E.H`fragAlpha = fragColor.a;`)}`);break;case a.V.ObjectAndLayerIdColor:R.main.add(E.H`
        ${V}
        outputObjectAndLayerIdColor();`);break;case a.V.Highlight:e.include(p.Q,t),R.main.add(E.H`
        ${V}
        outputHighlight(voccluded == 1.0);`)}return e}function P(t){return t.outlineColor[3]>0&&t.outlineSize>0}function z(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:I;return t.textureIsSignedDistanceField?function(t,e,i){null!=e?(0,r.hZ)(i,t[0]*(e[2]-e[0])+e[0],t[1]*(e[3]-e[1])+e[1]):(0,r.hZ)(i,0,0)}(t.anchorPosition,t.distanceFieldBoundingBox,e):(0,r.C)(e,t.anchorPosition),e}const I=(0,s.vt)(),F=Object.freeze(Object.defineProperty({__proto__:null,build:R,calculateAnchorPosForRendering:z,shaderSettings:D},Symbol.toStringTag,{value:"Module"}))},75941:(t,e,i)=>{i.d(e,{O:()=>r});class r{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return 0===this._outer.size}get(t,e){return this._outer.get(t)?.get(e)}getInner(t){return this._outer.get(t)}set(t,e,i){const r=this._outer.get(t);r?r.set(e,i):this._outer.set(t,new Map([[e,i]]))}delete(t,e){const i=this._outer.get(t);i&&(i.delete(e),0===i.size&&this._outer.delete(t))}forEach(t){this._outer.forEach(((e,i)=>t(e,i)))}forAll(t){for(const e of this._outer.values())for(const i of e.values())t(i)}}},60216:(t,e,i)=>{i.d(e,{E:()=>n});var r=i(9392),s=(i(9624),i(14487));function n(t,e,i){return!!(0,s.F)(t,e,o,i.spatialReference)&&(i.x=o[0],i.y=o[1],i.z=o[2],!0)}const o=(0,r.vt)()},57481:(t,e,i)=>{i.d(e,{U:()=>n});var r=i(93345),s=i(21812);function n(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const i=t.stride;return Array.from(t.fields.keys()).map((r=>{const n=t.fields.get(r),a=n.constructor.ElementCount,l=o(n.constructor.ElementType),h=n.offset,c=n.optional?.glNormalized??!1;return new s._(r,a,l,h,i,c,e)}))}function o(t){const e=a[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}const a={u8:r.pe.UNSIGNED_BYTE,u16:r.pe.UNSIGNED_SHORT,u32:r.pe.UNSIGNED_INT,i8:r.pe.BYTE,i16:r.pe.SHORT,i32:r.pe.INT,f32:r.pe.FLOAT}},38280:(t,e,i)=>{i.d(e,{I:()=>o});var r=i(98720),s=i(94192),n=i(64839);function o(t,e){const{vertex:i,fragment:o}=t;t.include(s.Z,e),i.include(r.K),e.terrainDepthTest&&t.varyings.add("depth","float"),i.main.add(n.H`
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${e.terrainDepthTest?n.H`depth = projectAux.posView.z;`:""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  `),o.main.add(n.H`fragColor = vec4(1);
if(terrainDepthTest(depth)) {
fragColor.g = 0.5;
}`)}},60586:(t,e,i)=>{i.d(e,{Cc:()=>l,RW:()=>a,VM:()=>h});var r=i(91967),s=i(34981);const n={required:[]};s.V.Depth;class o extends r.A{precompile(t){const e=this.acquireTechniques(t);return h(e),null!=e}consumes(){return n}get usedMemory(){return 0}get isDecoration(){return!1}get running(){return!1}modify(t){}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmissions(){return!1}forEachGeometry(t){}queryRenderOccludedState(t){return!1}}class a extends o{}class l extends o{}function h(t){Array.isArray(t)?t.forEach((t=>t?.release())):t?.release()}},63496:(t,e,i)=>{i.d(e,{VR:()=>s,a0:()=>o});var r=i(30015);class s{constructor(){this.adds=new r.A,this.removes=new r.A,this.updates=new r.A({allocator:t=>t||new n,deallocator:t=>(t.renderGeometry=null,t)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return 0===this.adds.length&&0===this.removes.length&&0===this.updates.length}}class n{}class o{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}},50255:(t,e,i)=>{i.d(e,{c:()=>s});var r=i(83490);class s{constructor(t,e){this._material=t,this._repository=e,this._map=new Map}dispose(){this._map.forEach(((t,e)=>{null!=t&&this._repository.release(this._material,e)}))}load(t,e,i){const s=this._material.produces.get(e);if(!s?.(i))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,e,i));const n=this._map.get(i);if(null!=n){if(n.ensureResources(t)===r.Am.LOADED)return n;this._repository.requestRender()}return null}}},57824:(t,e,i)=>{var r,s;i.d(e,{k:()=>s,q:()=>r}),function(t){t[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.REMOVE=2]="REMOVE"}(r||(r={})),function(t){t[t.NONE=0]="NONE",t[t.VISIBILITY=1]="VISIBILITY",t[t.GEOMETRY=2]="GEOMETRY",t[t.TRANSFORMATION=4]="TRANSFORMATION",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.OCCLUDEE=16]="OCCLUDEE"}(s||(s={}))},69008:(t,e,i)=>{i.d(e,{Z:()=>s});var r=i(36911);class s extends r.Z{}},13840:(t,e,i)=>{i.d(e,{$T:()=>o,zj:()=>s});var r,s,n=i(63496);function o(t){const e=new Map,i=t=>{let i=e.get(t);return i||(i=new n.a0,e.set(t,i)),i};return t.removes.forAll((t=>{a(t)&&i(t.material).removes.push(t)})),t.adds.forAll((t=>{a(t)&&i(t.material).adds.push(t)})),t.updates.forAll((t=>{a(t.renderGeometry)&&i(t.renderGeometry.material).updates.push(t)})),e}function a(t){return t.geometry.indexCount>=1}!function(t){t[t.Default=0]="Default",t[t.Screenshot=1]="Screenshot",t[t.ObjectAndLayerID=2]="ObjectAndLayerID"}(r||(r={})),function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"}(s||(s={}))},16699:(t,e,i)=>{i.d(e,{P:()=>n});var r=i(9392),s=i(55386);class n extends s.gy{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,r.vt)();super(),this.origin=t}get slicePlaneLocalOrigin(){return this.origin}}},12536:(t,e,i)=>{i.d(e,{R:()=>$});var r=i(15941),s=i(63919),n=i(44680),o=i(34761),a=i(13191),l=i(19555),h=i(72745),c=i(20664),u=i(9392),d=i(55855);function f(t){return function(t){return t instanceof Float32Array&&t.length>=16}(t)||function(t){return Array.isArray(t)&&t.length>=16}(t)}var p=i(2413),g=i(88105),_=i(63048),m=i(22955),v=i(48549),y=i(34981),w=i(40318),x=i(90235),b=i(61785),A=i(75803),O=i(45463),E=i(77730),T=i(12028),C=i(86994),S=i(66470);class M{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}}var D=i(52757),R=i(99362),P=i(19061),z=i(16506),I=i(59246),F=i(72001),N=i(60322),B=i(93345),j=i(57162);class V extends I.w{constructor(t,e,r){super(t,e,new z.$(P.H,(()=>i.e(271).then(i.bind(i,60271)))),r),this.primitiveType=e.occlusionPass?B.WR.POINTS:B.WR.TRIANGLES}initializePipeline(t){const{oitPass:e,hasPolygonOffset:i,draped:r,output:s,depthTestEnabled:n}=t,o=e===F.Y.NONE,a=i?H:null,l=e===F.Y.ColorAlpha,h=r||!n||l||s===y.V.Highlight?null:j.Uy;return(0,j.Ey)({blending:s===y.V.Color?o?j.Os:(0,N.ez)(e):null,depthTest:n&&!r?{func:B.MT.LEQUAL}:null,depthWrite:h,drawBuffers:(0,N.m6)(e,s),colorWrite:j.kn,polygonOffset:a})}}const H={factor:0,units:-4};var L=i(35143),U=i(97808),G=i(42717),Z=i(6485),W=i(94570);class Y extends W.E{constructor(t){super(),this.spherical=t,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hasRotation=!1,this.debugDrawLabelBorder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthTestEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.occlusionPass=!1,this.occludedFragmentFade=!1,this.objectAndLayerIdColorInstanced=!1,this.horizonCullingEnabled=!0,this.textureCoordinateType=U.I.None,this.emissionSource=G.ZX.None,this.discardInvisibleFragments=!0,this.hasSliceInVertexProgram=!0,this.hasVvInstancing=!1}}(0,L._)([(0,Z.W)()],Y.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"occlusionTestEnabled",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"signedDistanceFieldEnabled",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"vvSize",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"vvColor",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"hasVerticalOffset",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"hasScreenSizePerspective",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"hasRotation",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"debugDrawLabelBorder",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"hasSlicePlane",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"hasPolygonOffset",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"depthTestEnabled",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"pixelSnappingEnabled",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"draped",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"terrainDepthTest",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"cullAboveTerrain",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"occlusionPass",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"occludedFragmentFade",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"objectAndLayerIdColorInstanced",void 0),(0,L._)([(0,Z.W)()],Y.prototype,"horizonCullingEnabled",void 0);class $ extends O.im{constructor(t,e){super(t,_t),this.produces=new Map([[E.N.HUD_MATERIAL,t=>(0,y.dX)(t)&&!this.parameters.drawInSecondSlot],[E.N.LABEL_MATERIAL,t=>(0,y.dX)(t)&&this.parameters.drawInSecondSlot],[E.N.OCCLUSION_PIXELS,()=>this.parameters.occlusionTest],[E.N.DRAPED_MATERIAL,t=>this.parameters.draped&&(0,y.dX)(t)]]),this._visible=!0,this._configuration=new Y(e)}getConfiguration(t,e){return this._configuration.output=t,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.draped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.hasRotation=this.parameters.hasRotation,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=e.slot===E.N.OCCLUSION_PIXELS,this._configuration.occludedFragmentFade=this.parameters.occludedFragmentFade,this._configuration.horizonCullingEnabled=this.parameters.horizonCullingEnabled,this._configuration.depthTestEnabled=this.parameters.depthEnabled||e.slot===E.N.OCCLUSION_PIXELS,t===y.V.Color&&(this._configuration.debugDrawLabelBorder=!!m.b.LABELS_SHOW_BORDER),this._configuration.oitPass=e.oitPass,this._configuration.terrainDepthTest=e.terrainDepthTest,this._configuration.cullAboveTerrain=e.cullAboveTerrain,this._configuration}intersect(t,e,i,r,n,a){const{options:{selectionMode:l,hud:h,excludeLabels:d},point:f,camera:p}=i,{parameters:g}=this;if(!l||!h||d&&g.isLabel||!t.visible||!f)return;const{scaleX:_,scaleY:m}=this._getScreenScale(t,p.pixelRatio);(0,s.z0)(nt,e),t.attributes.has(S.r.FEATUREATTRIBUTE)&&function(t){const e=t[0],i=t[1],r=t[2],s=t[3],n=t[4],o=t[5],a=t[6],l=t[7],h=t[8],c=1/Math.sqrt(e*e+i*i+r*r),u=1/Math.sqrt(s*s+n*n+o*o),d=1/Math.sqrt(a*a+l*l+h*h);t[0]=e*c,t[1]=i*c,t[2]=r*c,t[3]=s*u,t[4]=n*u,t[5]=o*u,t[6]=a*d,t[7]=l*d,t[8]=h*d}(nt);const v=t.attributes.get(S.r.POSITION),y=t.attributes.get(S.r.SIZE),w=t.attributes.get(S.r.NORMAL),x=t.attributes.get(S.r.ROTATION),b=t.attributes.get(S.r.CENTEROFFSETANDDISTANCE);(0,C.vA)(v.size>=3);const A=(0,P.c)(g),O="screen"===this.parameters.centerOffsetUnits;for(let s=0;s<v.data.length/v.size;s++){const t=s*v.size;(0,c.i)(K,v.data[t],v.data[t+1],v.data[t+2]),(0,c.t)(K,K,e),(0,c.t)(K,K,p.viewMatrix);const r=s*b.size;if((0,c.i)(lt,b.data[r],b.data[r+1],b.data[r+2]),!O&&(K[0]+=lt[0],K[1]+=lt[1],0!==lt[2])){const t=lt[2];(0,c.n)(lt,K),(0,c.d)(K,K,(0,c.h)(lt,lt,t))}const n=s*w.size;if((0,c.i)(J,w.data[n],w.data[n+1],w.data[n+2]),k(J,nt,p,ut),this._applyVerticalOffsetTransformationView(K,ut,p,Q),p.applyProjection(K,tt),tt[0]>-1){O&&(lt[0]||lt[1])&&(tt[0]+=lt[0]*p.pixelRatio,0!==lt[1]&&(tt[1]+=(0,T.m0)(lt[1],Q.factorAlignment)*p.pixelRatio),p.unapplyProjection(tt,K)),tt[0]+=this.parameters.screenOffset[0]*p.pixelRatio,tt[1]+=this.parameters.screenOffset[1]*p.pixelRatio,tt[0]=Math.floor(tt[0]),tt[1]=Math.floor(tt[1]);const t=s*y.size;pt[0]=y.data[t],pt[1]=y.data[t+1],(0,T.MD)(pt,Q.factor,pt);const e=dt*p.pixelRatio;let r=0;g.textureIsSignedDistanceField&&(r=Math.min(g.outlineSize,.5*pt[0])*p.pixelRatio/2),pt[0]*=_,pt[1]*=m;const n=s*x.size,l=g.rotation+x.data[n];if(X(f,tt[0],tt[1],pt,e,r,l,g,A)){const t=i.ray;if((0,c.t)(it,K,(0,o.B8)(at,p.viewMatrix)),tt[0]=f[0],tt[1]=f[1],p.unprojectFromRenderScreen(tt,K)){const e=(0,u.vt)();(0,c.c)(e,t.direction);const i=1/(0,c.l)(e);(0,c.h)(e,e,i),a((0,c.j)(t.origin,K)*i,e,-1,!0,1,it)}}}}}intersectDraped(t,e,i,r,s,n){const o=t.attributes.get(S.r.POSITION),a=t.attributes.get(S.r.SIZE),l=t.attributes.get(S.r.ROTATION),h=this.parameters,c=(0,P.c)(h),{scaleX:u,scaleY:d}=this._getScreenScale(t,t.screenToWorldRatio),f=ft*t.screenToWorldRatio;for(let p=0;p<o.data.length/o.size;p++){const e=p*o.size,i=o.data[e],g=o.data[e+1],_=p*a.size;pt[0]=a.data[_],pt[1]=a.data[_+1];let m=0;h.textureIsSignedDistanceField&&(m=Math.min(h.outlineSize,.5*pt[0])*t.screenToWorldRatio/2),pt[0]*=u,pt[1]*=d;const v=p*l.size,y=h.rotation+l.data[v];X(r,i,g,pt,f,m,y,h,c)&&s(n.dist,n.normal,-1,!1)}}createBufferWriter(){return new yt}_updateScaleInfo(t,e,i){const r=this.parameters;null!=r.screenSizePerspective?(0,T.cJ)(i,e,r.screenSizePerspective,t.factor):(t.factor.scale=1,t.factor.factor=0,t.factor.minScaleFactor=0),null!=r.screenSizePerspectiveAlignment?(0,T.cJ)(i,e,r.screenSizePerspectiveAlignment,t.factorAlignment):(t.factorAlignment.factor=t.factor.factor,t.factorAlignment.scale=t.factor.scale,t.factorAlignment.minScaleFactor=t.factor.minScaleFactor)}applyShaderOffsetsView(t,e,i,r,s,n,o){const a=k(e,i,s,ut);return this._applyVerticalGroundOffsetView(t,a,s,o),this._applyVerticalOffsetTransformationView(o,a,s,n),this._applyPolygonOffsetView(o,a,r[3],s,o),this._applyCenterOffsetView(o,r,o),o}applyShaderOffsetsNDC(t,e,i,r,s){return this._applyCenterOffsetNDC(t,e,i,r),null!=s&&(0,c.c)(s,r),this._applyPolygonOffsetNDC(r,e,i,r),r}_applyPolygonOffsetView(t,e,i,s,n){const o=s.aboveGround?1:-1;let a=Math.sign(i);0===a&&(a=o);const l=o*a;if(this.parameters.shaderPolygonOffset<=0)return(0,c.c)(n,t);const h=(0,r.qE)(Math.abs(e.cosAngle),.01,1),u=1-Math.sqrt(1-h*h)/h/s.viewport[2];return(0,c.h)(n,t,l>0?u:1/u),n}_applyVerticalGroundOffsetView(t,e,i,r){const s=(0,c.l)(t),n=i.aboveGround?1:-1,o=i.computeRenderPixelSizeAtDist(s)*w.R,a=(0,c.h)(K,e.normal,n*o);return(0,c.g)(r,t,a),r}_applyVerticalOffsetTransformationView(t,e,i,r){const s=this.parameters;if(!s.verticalOffset?.screenLength){if(s.screenSizePerspective||s.screenSizePerspectiveAlignment){const i=(0,c.l)(t);this._updateScaleInfo(r,i,e.cosAngle)}else r.factor.scale=1,r.factorAlignment.scale=1;return t}const n=(0,c.l)(t),o=s.screenSizePerspectiveAlignment??s.screenSizePerspective,a=(0,R.kE)(i,n,s.verticalOffset,e.cosAngle,o);return this._updateScaleInfo(r,n,e.cosAngle),(0,c.h)(e.normal,e.normal,a),(0,c.g)(t,t,e.normal)}_applyCenterOffsetView(t,e,i){const r="screen"!==this.parameters.centerOffsetUnits;return i!==t&&(0,c.c)(i,t),r&&(i[0]+=e[0],i[1]+=e[1],e[2]&&((0,c.n)(J,i),(0,c.g)(i,i,(0,c.h)(J,J,e[2])))),i}_applyCenterOffsetNDC(t,e,i,r){const s="screen"!==this.parameters.centerOffsetUnits;return r!==t&&(0,c.c)(r,t),s||(r[0]+=e[0]/i.fullWidth*2,r[1]+=e[1]/i.fullHeight*2),r}_applyPolygonOffsetNDC(t,e,i,r){const s=this.parameters.shaderPolygonOffset;if(t!==r&&(0,c.c)(r,t),s){const t=i.aboveGround?1:-1,n=t*Math.sign(e[3]);r[2]-=(n||t)*s}return r}set visible(t){this._visible=t}get visible(){const{color:t,outlineSize:e,outlineColor:i}=this.parameters,r=t[3]>=x.Q||e>=x.Q&&i[3]>=x.Q;return this._visible&&r}createGLMaterial(t){return new q(t)}calculateRelativeScreenBounds(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,p.vt)();return function(t,e,i,r){r[0]=t.anchorPosition[0]*-e[0]+t.screenOffset[0]*i,r[1]=t.anchorPosition[1]*-e[1]+t.screenOffset[1]*i}(this.parameters,t,e,i),i[2]=i[0]+t[0],i[3]=i[1]+t[1],i}_getScreenScale(t,e){const i=t.attributes.get(S.r.FEATUREATTRIBUTE);if(null==i)return{scaleX:e,scaleY:e};const r=(0,d.ci)(i.data,ct);return(0,_.VC)(ht,this.parameters,r),{scaleX:ht[0]*e,scaleY:ht[1]*e}}}class q extends A.m8{constructor(t){super({...t,...t.material.parameters})}beginSlot(t){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.acquireTechnique(V,t)}}function k(t,e,i,r){return f(e)&&(e=(0,s.z0)(ot,e)),(0,c.q)(r.normal,t,e),(0,c.t)(r.normal,r.normal,i.viewInverseTransposeMatrix),r.cosAngle=(0,c.f)(et,gt),r}function X(t,e,i,s,n,o,a,h,c){let u=e-n-s[0]*c[0],d=u+s[0]+2*n,f=i-n-s[1]*c[1],p=f+s[1]+2*n;const g=h.distanceFieldBoundingBox;return h.textureIsSignedDistanceField&&null!=g&&(u+=s[0]*g[0],f+=s[1]*g[1],d-=s[0]*(1-g[2]),p-=s[1]*(1-g[3]),u-=o,d+=o,f-=o,p+=o),(0,l.hZ)(st,e,i),(0,l.e$)(rt,t,st,(0,r.kU)(a)),rt[0]>u&&rt[0]<d&&rt[1]>f&&rt[1]<p}const Q=new class{constructor(){this.factor=new M,this.factorAlignment=new M}},K=(0,u.vt)(),J=(0,u.vt)(),tt=(0,d.vt)(),et=(0,u.vt)(),it=(0,u.vt)(),rt=(0,h.vt)(),st=(0,h.vt)(),nt=(0,n.vt)(),ot=(0,n.vt)(),at=(0,a.vt)(),lt=(0,u.vt)(),ht=(0,u.vt)(),ct=(0,d.vt)(),ut={normal:et,cosAngle:0},dt=1,ft=2,pt=[0,0],gt=(0,u.fA)(0,0,1);class _t extends A.NV{constructor(){super(...arguments),this.renderOccluded=O.m$.Occlude,this.isDecoration=!1,this.color=(0,d.CN)(1,1,1,1),this.polygonOffset=!1,this.anchorPosition=(0,h.fA)(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=(0,d.CN)(1,1,1,1),this.outlineSize=0,this.rotation=0,this.hasRotation=!1,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.occludedFragmentFade=!1,this.horizonCullingEnabled=!1,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.draped=!1,this.isLabel=!1}}const mt=(0,v.BP)().vec3f(S.r.POSITION).vec3f(S.r.NORMAL).vec2f(S.r.UV0).vec4u8(S.r.COLOR).vec2f(S.r.SIZE).f32(S.r.ROTATION).vec4f(S.r.CENTEROFFSETANDDISTANCE).vec4f(S.r.FEATUREATTRIBUTE),vt=mt.clone().vec4u8(S.r.OBJECTANDLAYERIDCOLOR);class yt{constructor(){this.vertexBufferLayout=(0,b.E)()?vt:mt}elementCount(t){return 6*t.get(S.r.POSITION).indices.length}write(t,e,i,r,s,n){(0,D.Hk)(i.get(S.r.POSITION),t,s.position,n,6),(0,D.p1)(i.get(S.r.NORMAL),e,s.normal,n,6);const o=i.get(S.r.UV0)?.data;let a=0,l=0,h=1,c=1;o&&o.length>=4&&(a=o[0],l=o[1],h=o[2],c=o[3]),h=Math.min(1.99999,h+1),c=Math.min(1.99999,c+1);let u=i.get(S.r.POSITION).indices.length,d=n;const f=s.uv0;for(let g=0;g<u;++g)f.set(d,0,a),f.set(d,1,l),d++,f.set(d,0,h),f.set(d,1,l),d++,f.set(d,0,h),f.set(d,1,c),d++,f.set(d,0,h),f.set(d,1,c),d++,f.set(d,0,a),f.set(d,1,c),d++,f.set(d,0,a),f.set(d,1,l),d++;(0,D.tb)(i.get(S.r.COLOR),4,s.color,n,6);const{data:p,indices:_}=i.get(S.r.SIZE);u=_.length;const m=s.size;d=n;for(let g=0;g<u;++g){const t=p[2*_[g]],e=p[2*_[g]+1];for(let i=0;i<6;++i)m.set(d,0,t),m.set(d,1,e),d++}if((0,D.uO)(i.get(S.r.ROTATION),s.rotation,n,6),i.get(S.r.CENTEROFFSETANDDISTANCE)?(0,D.Ut)(i.get(S.r.CENTEROFFSETANDDISTANCE),s.centerOffsetAndDistance,n,6):(0,D.Pq)(s.centerOffsetAndDistance,n,6*u),i.get(S.r.FEATUREATTRIBUTE)?(0,D.Ut)(i.get(S.r.FEATUREATTRIBUTE),s.featureAttribute,n,6):(0,D.Pq)(s.featureAttribute,n,6*u),null!=r){const t=i.get(S.r.POSITION)?.indices;if(t){const e=t.length,i=s.getField(S.r.OBJECTANDLAYERIDCOLOR,g.XP);(0,D.tH)(r,i,e,n,6)}}}}},96840:(t,e,i)=>{i.d(e,{y:()=>D,N:()=>G});var r=i(35143),s=i(18690),n=(i(81806),i(15941)),o=i(30726),a=i(75941),l=i(30015),h=i(41289),c=i(46053),u=(i(76460),i(85842)),d=i(34761),f=i(13191),p=i(57481),g=i(34981),_=i(60586),m=i(50255),v=i(57824),y=i(77730),w=i(86994),x=i(16699);class b{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.from=t,this.to=e}get numElements(){return this.to-this.from}}function A(t){const e=new Map;t.forAll((t=>e.set(t.from,t)));let i=!0;for(;i;){i=!1;for(let r=0;r<t.length;++r){const s=t.data[r],n=e.get(s.to);if(!n)return;s.to=n.to,e.delete(n.from),t.removeUnordered(n),i=!0}}}class O extends b{constructor(t,e,i){super(e,i),this.geometry=t}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}foreachHighlightGroup(t){this.isVisible&&this.geometry.foreachHighlightGroup(t)}get hasOccludees(){return null!=this.geometry.occludees}}class E{constructor(){this.first=0,this.count=0}}class T{constructor(){this._numElements=0,this._instances=new Map,this.holes=new l.A({allocator:t=>t||new b,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightGroups=new Set,this.drawCommandsDefault=C(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=C(),this.drawCommandsShadowHighlightRest=C()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightGroups.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightGroups.clear()}updateIfDrawCommandsDirty(t){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const t of this.instances.values())this.updateDrawState(t);this.updateDrawCommands(t)}}addInstance(t,e){this.deleteInstance(t),this._instances.set(t,e),this._numElements+=e.numElements}deleteInstance(t){const e=this._instances.get(t);e&&(this._numElements-=e.numElements,this._instances.delete(t))}updateInstance(t,e,i){const r=this._instances.get(t);r&&(this._numElements-=r.numElements,r.from=e,r.to=i,this._numElements+=r.numElements)}updateDrawState(t){t.isVisible?(t.foreachHighlightGroup((t=>this.highlightGroups.add(t))),t.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(t){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlights.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;if(!this.needsMultipleCommands()){const e=this.drawCommandsDefault.pushNew(),i=this.holes.front();return null!=this.vao&&1===this.holes.length&&i.to===Math.floor(this.vao.byteSize/t)?(e.first=0,void(e.count=i.from)):(e.first=1/0,e.count=0,this._instances.forEach((t=>{e.first=Math.min(e.first,t.from),e.count=Math.max(e.count,t.to)})),void(e.count-=e.first))}const e=Array.from(this._instances.values()).sort(((t,e)=>t.from===e.from?t.to-e.to:t.from-e.from)),{drawCommandsHighlights:i}=this;for(const r of e)r.isVisible&&(S(r.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,r),r.hasHighlights?r.foreachHighlightGroup((t=>{let e=i.get(t);e||(e=C(),i.set(t,e)),S(e,r)})):S(this.drawCommandsShadowHighlightRest,r))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function C(){return new l.A({allocator:t=>t||new E,deallocator:t=>t})}function S(t,e){const i=t.back();if(null==i){const i=t.pushNew();return i.first=e.from,void(i.count=e.numElements)}if(function(t,e){return t.first+t.count>=e.from}(i,e)){const t=e.from-i.first+e.numElements;i.count=t}else{const i=t.pushNew();i.first=e.from,i.count=e.numElements}}class M{constructor(t){this.origin=t,this.buffers=new Array}dispose(){this.buffers.forEach((t=>t.vao.dispose())),this.buffers.length=0}findBuffer(t){return this.buffers.find((e=>e.instances.has(t)))}}let D=class extends _.RW{get _hasAnyHighlight(){return this._highlightGroups.size>0}constructor(t){super(t),this._dataByOrigin=new Map,this._drawParameters=new x.P,this._highlightGroups=new Set,this.drapedPriority=0,this._produces=new Map,this._hasOccludees=!1}destroy(){this._glMaterials=(0,o.WD)(this._glMaterials),this._dataByOrigin.forEach((t=>t.dispose())),this._dataByOrigin.clear(),this._vaoCache=null}initialize(){this.material.produces.forEach(((t,e)=>{this._produces.set(e,(e=>!(0===this._dataByOrigin.size||!(e!==g.V.Highlight&&e!==g.V.ShadowHighlight||this._hasAnyHighlight))&&t(e)))}))}initializeRenderContext(t,e){this._glMaterials=new m.c(this.material,e??t.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=t.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,(0,p.U)(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(t){return this.material.queryRenderOccludedState(t)}get numGeometries(){let t=0;return this._dataByOrigin.forEach((e=>t+=e.buffers.reduce(((t,e)=>t+e.instances.size),0))),t}get usedMemory(){let t=0;return this._dataByOrigin.forEach((e=>t+=e.buffers.reduce(((t,e)=>t+e.vao.usedMemory),0))),t}forEachGeometry(t){this._dataByOrigin.forEach((e=>e.buffers.forEach((e=>e.instances.forEach((e=>{let{geometry:i}=e;return t(i)}))))))}modify(t){this._updateGeometries(t.updates),this._addAndRemoveGeometries(t.adds,t.removes),this._updateDrawCommands()}_updateGeometries(t){const e=this._bufferWriter;if(null==e)return;const i=e.vertexBufferLayout.stride/4;for(const r of t){const t=r.renderGeometry,s=this._dataByOrigin.get(t.localOrigin.id),n=s?.findBuffer(t.id);if(null==n)return;const o=n.instances.get(t.id);if(r.updateType&(v.k.GEOMETRY|v.k.TRANSFORMATION)){const r=U(e.elementCount(o.geometry.geometry.attributes)*i),s=e.vertexBufferLayout.createView(r.buffer);this._writeGeometry(t,s,0),n.vao.vertexBuffers.get("geometry").setSubData(r,o.from*i,0,o.numElements*i)}r.updateType&(v.k.HIGHLIGHT|v.k.OCCLUDEE|v.k.VISIBILITY)&&(n.drawCommandsDirty=!0)}}_computeDeltas(t,e){const i=new a.O;for(const r of t){const t=r.localOrigin;if(null==t)continue;let e=i.get(t.id,null);null==e&&(e=new R(t.vec3),i.set(t.id,null,e)),e.changes.push(r)}for(const r of e){const t=r.localOrigin;if(null==t)continue;const e=this._dataByOrigin.get(t.id),s=e?.findBuffer(r.id);if(null==s)continue;let n=i.get(t.id,s);null==n&&(n=new R(t.vec3),i.set(t.id,s,n)),n.changes.push(r)}return i}_addAndRemoveGeometries(t,e){if(null==this._bufferWriter||null==this._vaoCache)return;const{_bufferWriter:i,_dataByOrigin:r}=this,n=i.vertexBufferLayout.stride/4,o=this._computeDeltas(t,e);o.forEach(((t,e)=>{const a=t.get(null),l=a?.changes??[];o.delete(e,null);let h=r.get(e);if(t.forEach(((t,a)=>{if(o.delete(e,a),null==a)return void(0,w.vA)(!1,"No VAO for removed geometries");if(a.instances.size===t.changes.length)return this._vaoCache.deleteVao(a.vao),(0,s.Xy)(h.buffers,a),void(0===h.buffers.length&&0===l.length&&r.delete(e));const c=a.numElements,u=a.vao.byteSize/4,d=l.reduce(((t,e)=>t+i.elementCount(e.geometry.attributes)),0),f=t.changes.reduce(((t,e)=>t+i.elementCount(e.geometry.attributes)),0),p=Math.min((c+d-f)*n,H),g=p>u;p>N&&p<u/2?(t.changes.forEach((t=>{let{id:e}=t;return a.deleteInstance(e)})),a.instances.forEach((t=>{let{geometry:e}=t;return l.push(e)})),this._vaoCache.deleteVao(a.vao),(0,s.Xy)(h.buffers,a)):g?this._applyAndRebuild(a,l,t):this._applyRemoves(a,t)})),l.length>0)for(null==h&&(h=new M(a.origin),r.set(e,h)),h.buffers.forEach((t=>this._applyAdds(t,l)));l.length>0;)h.buffers.push(this._applyAndRebuild(new T,l,null))}))}_updateDrawCommands(){this._highlightGroups.clear(),this._hasOccludees=!1,this._dataByOrigin.forEach((t=>{t.buffers.forEach((t=>{t.updateIfDrawCommandsDirty(this._bufferWriter.vertexBufferLayout.stride),t.hasHighlights&&(0,h.FB)(this._highlightGroups,t.highlightGroups),this._hasOccludees=this._hasOccludees||t.hasOccludees}))}))}_applyAndRebuild(t,e,i){if(i)for(const f of i.changes)t.deleteInstance(f.id);const r=this._bufferWriter,s=r.vertexBufferLayout.stride,n=s/4,o=Math.floor(H/n);let a=t.numElements;for(;e.length>0;){const i=e.pop(),s=r.elementCount(i.geometry.attributes);if(a+s>o&&a>0){e.push(i);break}a+=s;const n=new O(i,0,0);(0,w.vA)(null==t.instances.get(i.id)),t.addInstance(i.id,n)}const l=a*n,h=U(l),c=r.vertexBufferLayout.createView(h.buffer);let u=0;t.resetInstanceSummary(),t.instances.forEach(((e,i)=>{this._writeGeometry(e.geometry,c,u);const s=u;u+=r.elementCount(e.geometry.geometry.attributes),t.updateInstance(i,s,u),t.updateDrawState(e)})),this._vaoCache.deleteVao(t.vao),t.vao=this._vaoCache.newVao(G(l)),t.vao.vertexBuffers.get("geometry").setSubData(h,0,0,u*n),t.holes.clear();const d=t.holes.pushNew();return d.from=u,d.to=Math.floor(t.vao.byteSize/s),t.updateDrawCommands(s),t}_applyRemoves(t,e){if(0===e.changes.length||null==this._bufferWriter)return;for(const o of e.changes){const e=o.id,i=t.instances.get(e);if(!i)continue;t.deleteInstance(e);const r=F.back();if(r){if(r.to===i.from){r.to=i.to;continue}if(r.from===i.to){r.from=i.from;continue}}const s=F.pushNew();s.from=i.from,s.to=i.to}A(F);const i=this._bufferWriter.vertexBufferLayout.stride/4,r=F.reduce(((t,e)=>Math.max(t,e.numElements)),0)*i,s=U(r);s.fill(0,0,r);const n=t.vao.vertexBuffers.get("geometry");F.forAll((t=>n.setSubData(s,t.from*i,0,t.numElements*i))),t.holes.pushArray(F.data,F.length),F.forAll(((t,e)=>F.data[e]=null)),F.clear(),t.drawCommandsDirty=!0}_applyAdds(t,e){if(0===e.length||null==this._bufferWriter)return;if(!function(t){return null!=t.vao}(t))return void this._applyAndRebuild(t,e,null);const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4,n=t.numElements,o=e.reduce(((t,e)=>t+i.elementCount(e.geometry.attributes)),0),a=Math.min((n+o)*r,H),l=4*a;if(t.vao.byteSize<G(H-N)&&l>t.vao.byteSize)return void this._applyAndRebuild(t,e,null);A(t.holes);const h=new Array;for(const s of e){const e=i.elementCount(s.geometry.attributes),r=P(t.holes,e);h.push(r)}const c=t.vao.vertexBuffers.get("geometry");let u=0,d=0,f=0;const p=U(a),g=i.vertexBufferLayout.createView(p.buffer);e.forEach(((e,s)=>{const n=h[s];if(null==n)return;if(f!==n){const t=f-d;t>0&&c.setSubData(p,d*r,0,t*r),d=n,u=0}const o=i.elementCount(e.geometry.attributes);this._writeGeometry(e,g,u),u+=o,f=n+o;const a=new O(e,n,n+o);(0,w.vA)(null==t.instances.get(e.id)),t.addInstance(e.id,a),t.drawCommandsDirty=!0}));const _=f-d;_>0&&c.setSubData(p,d*r,0,_*r),(0,s.$i)(e,((t,e)=>null==h[e]))}_writeGeometry(t,e,i){null!=this._bufferWriter&&((0,d.C)(z,t.transformation),z[12]-=t.localOrigin.vec3[0],z[13]-=t.localOrigin.vec3[1],z[14]-=t.localOrigin.vec3[2],(0,d.B8)(I,z),(0,d.mg)(I,I),this._bufferWriter.write(z,I,t.geometry.attributes,t.geometry.objectAndLayerIdColor,e,i))}updateAnimation(t){return this.material.update(t)}acquireTechniques(t){if(!this.material.shouldRender(t))return null;const{output:e,bind:i}=t,r=this.material.produces.get(i.slot);if(!r?.(e))return null;const{highlightGroupName:s,slot:n}=i,o=e===g.V.ShadowHighlight,a=e===g.V.Highlight,l=a||o,h=t=>l&&(0===this._highlightGroups.size||a&&!!s&&!t.has(s));if(h(this._highlightGroups))return null;const c=e===g.V.ShadowExcludeHighlight,u=!(l||c);for(const{buffers:d}of this._dataByOrigin.values())for(const r of d){if(h(r.highlightGroups))continue;const a=o?r.drawCommandsHighlights.size>0:l?s?r.drawCommandsHighlights.get(s):r.drawCommandsHighlights.size>0:((c&&r.needsMultipleCommands()?r.drawCommandsShadowHighlightRest:r.drawCommandsDefault)||null)?.length??!1,d=u&&r.drawCommandsOccludees||null;if(a||d?.length){const r=this._glMaterials.load(t.rctx,n,e),s=r?.beginSlot(i);if(s)return s}}return null}render(t,e){const{output:i,bind:r}=t,{slot:s,highlightGroupName:n}=r,o=i===g.V.Highlight;if(o&&!n)return;const a=i===g.V.ShadowHighlight,l=o||a,h=i===g.V.ShadowExcludeHighlight,c=!(l||h),u=s===y.N.OCCLUDER_MATERIAL||s===y.N.TRANSPARENT_OCCLUDER_MATERIAL?s:null,{rctx:d}=t;d.runAppleAmdDriverHelper();const f=d.bindTechnique(e,r,this.material.parameters);for(const p of this._dataByOrigin.values())for(const t of p.buffers){if(o&&(!t.hasHighlights||!t.drawCommandsHighlights.has(n)))continue;if(a&&!t.hasHighlights)continue;const i=()=>{const e=[];for(const i of t.drawCommandsHighlights.values())e.push(i);return e},s=l&&!a?t.drawCommandsHighlights.get(n)??null:null,g=a?i():l?s?[s]:Z:(h&&t.needsMultipleCommands()?[t.drawCommandsShadowHighlightRest]:[t.drawCommandsDefault])||Z,_=g.some((t=>t.length>0)),m=c&&t.drawCommandsOccludees||null;if(_||m?.length){if(this._drawParameters.origin=p.origin,f.bindDraw(r,this.material.parameters,this._drawParameters),e.ensureAttributeLocations(t.vao),d.bindVAO(t.vao),_)for(const t of g)d.setPipelineState(e.getPipeline(!1,u)),t.forAll((t=>d.drawArrays(e.primitiveType,t.first,t.count)));m?.length&&(d.setPipelineState(e.getPipeline(!0,u)),m.forAll((t=>d.drawArrays(e.primitiveType,t.first,t.count))))}}}get test(){}};(0,r._)([(0,c.MZ)({constructOnly:!0})],D.prototype,"material",void 0),D=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],D);class R{constructor(t){this.origin=t,this.changes=new Array}}function P(t,e){const i=t.find((t=>t.numElements>=e));if(null==i)return null;const r=i.from;return i.from+=e,i.from>=i.to&&t.removeUnordered(i),r}const z=(0,f.vt)(),I=(0,f.vt)(),F=new l.A({allocator:t=>t||new b,deallocator:null}),N=65536,B=4*N,j=1024,V=16777216,H=V/4;let L=new Float32Array(N);function U(t){return L.length<t&&(L=new Float32Array(t)),L}function G(t){const e=4*t;return e<=j?j:e<B?(0,n.cU)(e):Math.max(Math.min(Math.ceil(1.5*e/B)*B,V),e)}const Z=[]},33062:(t,e,i)=>{i.d(e,{A:()=>E});var r=i(35143),s=i(91967),n=i(76460),o=i(15941),a=i(76931),l=i(46053),h=(i(81806),i(47249),i(85842)),c=i(34761),u=i(13191),d=i(19555),f=i(72745),p=i(20664),g=i(9392),_=i(43047),m=i(55855),v=i(4763),y=i(95925),w=i(96190),x=i(64465);var b,A=i(13840);let O=b=class extends s.A{constructor(t){super(t),this._ray=(0,y.vt)(),this._viewport=(0,m.fA)(0,0,1,1),this._padding=(0,m.fA)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=(0,f.fA)(1,1e3),this._viewDirty=!0,this._viewMatrix=(0,u.vt)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=(0,u.vt)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=(0,u.vt)(),this._frustumDirty=!0,this._frustum=(0,v.vt)(),this._fullViewport=(0,m.vt)(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=(0,g.vt)(),this._up=(0,g.vt)(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get rows(){return this._rows}set rows(t){this._rows=Math.max(1,t)}get columns(){return this._columns}set columns(t){this._columns=Math.max(1,t)}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center,"_center")}get ray(){return(0,p.d)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){(0,c.C)(this._viewMatrix,t),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),(0,p.i)((0,g.vt)(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),(0,p.i)((0,g.vt)(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),(0,p.i)((0,g.vt)(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get screenViewport(){if(1===this.pixelRatio)return this._viewport;const t=(0,_.d)((0,m.vt)(),this._viewport,1/this.pixelRatio),e=this._get("screenViewport");return e&&(0,_.e)(t,e)?e:t}get screenPadding(){if(1===this.pixelRatio)return this._padding;const t=(0,_.d)((0,m.vt)(),this._padding,1/this.pixelRatio),e=this._get("screenPadding");return e&&(0,_.e)(t,e)?e:t}get x(){return this._viewport[0]}set x(t){t+=this._padding[A.zj.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(t){t+=this._padding[A.zj.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[A.zj.RIGHT]+this._padding[A.zj.LEFT]}set fullWidth(t){this.width=t-(this._padding[A.zj.RIGHT]+this._padding[A.zj.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[A.zj.TOP]+this._padding[A.zj.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[A.zj.TOP]+this._padding[A.zj.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[A.zj.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[A.zj.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){(0,_.a)(this._padding,t)||(this._viewport[0]+=t[A.zj.LEFT]-this._padding[A.zj.LEFT],this._viewport[1]+=t[A.zj.BOTTOM]-this._padding[A.zj.BOTTOM],this._viewport[2]-=t[A.zj.RIGHT]+t[A.zj.LEFT]-(this._padding[A.zj.RIGHT]+this._padding[A.zj.LEFT]),this._viewport[3]-=t[A.zj.TOP]+t[A.zj.BOTTOM]-(this._padding[A.zj.TOP]+this._padding[A.zj.BOTTOM]),(0,_.c)(this._padding,t),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&((0,c.lw)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return(0,c.B8)((0,u.vt)(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||(0,u.vt)()}get fov(){return this._fov}set fov(t){this._fov=t,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return function(t,e,i){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+i*i))}(this._fov,this.width,this.height)}set fovX(t){this._fov=function(t,e,i){return 2*Math.atan(Math.sqrt(e*e+i*i)*Math.tan(.5*t)/e)}(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return function(t,e,i){return 2*Math.atan(i*Math.tan(.5*t)/Math.sqrt(e*e+i*i))}(this._fov,this.width,this.height)}set fovY(t){this._fov=function(t,e,i){return 2*Math.atan(Math.sqrt(e*e+i*i)*Math.tan(.5*t)/i)}(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return(0,p.j)(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&((0,c.B8)(this._viewInverseTransposeMatrix,this.viewMatrix),(0,c.mg)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const e=2*t-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return null!=this.relativeElevation&&this.relativeElevation>=0}get _projectionMatrixInternal(){const t=this.width,e=this.height,i=this.near*Math.tan(this.fovY/2)*2,r=i*this._aspect,s=i/this.rows,n=r/this.columns,o=-r/2+this.column*n,a=o+n,l=-i/2+this.row*s,h=l+s,d=(0,c.$h)((0,u.vt)(),o*(1+2*this._padding[A.zj.LEFT]/t),a*(1+2*this._padding[A.zj.RIGHT]/t),l*(1+2*this._padding[A.zj.BOTTOM]/e),h*(1+2*this._padding[A.zj.TOP]/e),this.near,this.far),f=this._get("projectionMatrix");return f&&(0,c.aI)(f,d)?f:d}copyFrom(t){(0,p.c)(this._ray.origin,t.eye),this.center=t.center,this.up=t.up,(0,_.c)(this._viewport,t.viewport),this.notifyChange("_viewport"),(0,_.c)(this._padding,t.padding),this.notifyChange("_padding"),(0,d.C)(this._nearFar,t.nearFar),this.notifyChange("_nearFar"),this._fov=t.fov,this.row=t.row,this.column=t.column,this.rows=t.rows,this.columns=t.columns,this.relativeElevation=t.relativeElevation;const e=t;return this._viewDirty=e._viewDirty,this._viewDirty||((0,c.C)(this._viewMatrix,t.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||((0,v.C)(this._frustum,t.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:((0,c.C)(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),(0,_.c)(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up,this.fov=t.fov}clone(){return(new b).copyFrom(this)}equals(t){return(0,p.p)(this.eye,t.eye)&&(0,p.p)(this.center,t.center)&&(0,p.p)(this.up,t.up)&&(0,_.a)(this._viewport,t.viewport)&&(0,_.a)(this._padding,t.padding)&&(0,d.t2)(this.nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation&&this.row===t.row&&this.column===t.column&&this.rows===t.rows&&this.columns===t.columns}almostEquals(t){const e=Math.max(1,1/this.pixelRatio,1/t.pixelRatio);if(Math.abs(t.fov-this._fov)>=.001||(0,_.f)(t.screenPadding,this.screenPadding)>=e||(0,_.f)(this.screenViewport,t.screenViewport)>=e||this.row!==t.row||this.column!==t.column||this.rows!==t.rows||this.columns!==t.columns)return!1;(0,p.a)(S,t.eye,t.center),(0,p.a)(M,this.eye,this.center);const i=(0,p.f)(S,M),r=(0,p.z)(S),s=(0,p.z)(M),n=5e-4;return i*i>=(1-1e-10)*r*s&&(0,p.y)(t.eye,this.eye)<Math.max(r,s)*n*n}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs((0,w.gr)(this.viewForward,(0,p.d)(S,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,a.gs)();return t[0]=(this.padding[A.zj.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[A.zj.TOP]+this.height/2)/this.pixelRatio,t}getRenderCenter(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;return t[0]=this.padding[A.zj.LEFT]+this.width*e,t[1]=this.padding[A.zj.BOTTOM]+this.height*i,t[2]=.5,t}setGLViewport(t){const e=this.viewport,i=this.padding;t.setViewport(e[0]-i[3],e[1]-i[2],e[2]+i[1]+i[3],e[3]+i[0]+i[2])}applyProjection(t,e){t!==T&&(0,p.c)(T,t),T[3]=1,(0,_.t)(T,T,this.projectionMatrix);const i=Math.abs(T[3]);(0,p.h)(T,T,1/i);const r=this.fullViewport;e[0]=(0,o.Cc)(0,r[0]+r[2],.5+.5*T[0]),e[1]=(0,o.Cc)(0,r[1]+r[3],.5+.5*T[1]),e[2]=.5*(T[2]+1),e[3]=i}unapplyProjection(t,e){const i=this.fullViewport;T[0]=(t[0]/(i[0]+i[2])*2-1)*t[3],T[1]=(t[1]/(i[1]+i[3])*2-1)*t[3],T[2]=(2*t[2]-1)*t[3],T[3]=t[3],null!=this.inverseProjectionMatrix&&((0,_.t)(T,T,this.inverseProjectionMatrix),e[0]=T[0],e[1]=T[1],e[2]=T[2])}projectToScreen(t,e){return this.projectToRenderScreen(t,D),this.renderToScreen(D,e),e}projectToRenderScreen(t,e){if(T[0]=t[0],T[1]=t[1],T[2]=t[2],T[3]=1,(0,_.t)(T,T,this.viewProjectionMatrix),0===T[3])return null;const i=T;(0,p.h)(i,i,1/Math.abs(T[3]));const r=this.fullViewport,s=(0,o.Cc)(0,r[0]+r[2],.5+.5*i[0]),n=(0,o.Cc)(0,r[1]+r[3],.5+.5*i[1]);return"x"in e?(e.x=s,e.y=n):(e[0]=s,e[1]=n,e.length>2&&(e[2]=.5*(i[2]+1))),e}unprojectFromScreen(t,e){return this.unprojectFromRenderScreen(this.screenToRender(t,D),e)}unprojectFromRenderScreen(t,e){if((0,c.lw)(C,this.projectionMatrix,this.viewMatrix),!(0,c.B8)(C,C))return null;const i=this.fullViewport;return T[0]=2*(t[0]-i[0])/i[2]-1,T[1]=2*(t[1]-i[1])/i[3]-1,T[2]=2*t[2]-1,T[3]=1,(0,_.t)(T,T,C),0===T[3]?null:(e[0]=T[0]/T[3],e[1]=T[1]/T[3],e[2]=T[2]/T[3],e)}constrainWindowSize(t,e,i,r){const s=t*this.pixelRatio,n=e*this.pixelRatio,o=Math.max(s-i/2,0),a=Math.max(this.fullHeight-n-r/2,0),l=-Math.min(s-i/2,0),h=-Math.min(this.fullHeight-n-r/2,0),c=i-l- -Math.min(this.fullWidth-s-i/2,0),u=r-h- -Math.min(n-r/2,0);return[Math.round(o),Math.round(a),Math.round(c),Math.round(u)]}computeUp(t){t===x.RT.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,e){const i=t[0]*this.pixelRatio,r=this.fullHeight-t[1]*this.pixelRatio;return e[0]=i,e[1]=r,e}renderToScreen(t,e){const i=t[0]/this.pixelRatio,r=(this.fullHeight-t[1])/this.pixelRatio;e[0]=i,e[1]=r}_computeUpGlobal(){(0,p.d)(S,this.center,this.eye);const t=(0,p.l)(this.center);t<1?((0,p.i)(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs((0,p.f)(S,this.center))>.9999*(0,p.l)(S)*t||((0,p.e)(this._up,S,this.center),(0,p.e)(this._up,this._up,S),(0,p.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){(0,p.o)(S,this.eye,this.center),Math.abs(S[2])<=.9999&&((0,p.h)(S,S,S[2]),(0,p.i)(this._up,-S[0],-S[1],1-S[2]),(0,p.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";"number"==typeof t[0]&&isFinite(t[0])&&"number"==typeof t[1]&&isFinite(t[1])&&"number"==typeof t[2]&&isFinite(t[2])?(0,p.p)(t,e)||((0,p.c)(e,t),this._markViewDirty(),i.length&&this.notifyChange(i)):n.A.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&((0,v.ui)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&((0,c.t5)(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};(0,r._)([(0,l.MZ)()],O.prototype,"_viewport",void 0),(0,r._)([(0,l.MZ)()],O.prototype,"_padding",void 0),(0,r._)([(0,l.MZ)()],O.prototype,"_fov",void 0),(0,r._)([(0,l.MZ)()],O.prototype,"_nearFar",void 0),(0,r._)([(0,l.MZ)()],O.prototype,"_viewDirty",void 0),(0,r._)([(0,l.MZ)()],O.prototype,"_viewMatrix",void 0),(0,r._)([(0,l.MZ)()],O.prototype,"_pixelRatio",void 0),(0,r._)([(0,l.MZ)()],O.prototype,"pixelRatio",null),(0,r._)([(0,l.MZ)()],O.prototype,"row",void 0),(0,r._)([(0,l.MZ)()],O.prototype,"column",void 0),(0,r._)([(0,l.MZ)()],O.prototype,"_rows",void 0),(0,r._)([(0,l.MZ)()],O.prototype,"rows",null),(0,r._)([(0,l.MZ)()],O.prototype,"_columns",void 0),(0,r._)([(0,l.MZ)()],O.prototype,"columns",null),(0,r._)([(0,l.MZ)()],O.prototype,"eye",null),(0,r._)([(0,l.MZ)()],O.prototype,"center",null),(0,r._)([(0,l.MZ)()],O.prototype,"_center",void 0),(0,r._)([(0,l.MZ)()],O.prototype,"up",null),(0,r._)([(0,l.MZ)()],O.prototype,"_up",void 0),(0,r._)([(0,l.MZ)()],O.prototype,"viewMatrix",null),(0,r._)([(0,l.MZ)({readOnly:!0})],O.prototype,"viewForward",null),(0,r._)([(0,l.MZ)({readOnly:!0})],O.prototype,"viewUp",null),(0,r._)([(0,l.MZ)({readOnly:!0})],O.prototype,"viewRight",null),(0,r._)([(0,l.MZ)({readOnly:!0})],O.prototype,"nearFar",null),(0,r._)([(0,l.MZ)()],O.prototype,"near",null),(0,r._)([(0,l.MZ)()],O.prototype,"far",null),(0,r._)([(0,l.MZ)()],O.prototype,"viewport",null),(0,r._)([(0,l.MZ)({readOnly:!0})],O.prototype,"screenViewport",null),(0,r._)([(0,l.MZ)({readOnly:!0})],O.prototype,"screenPadding",null),(0,r._)([(0,l.MZ)()],O.prototype,"x",null),(0,r._)([(0,l.MZ)()],O.prototype,"y",null),(0,r._)([(0,l.MZ)()],O.prototype,"width",null),(0,r._)([(0,l.MZ)()],O.prototype,"height",null),(0,r._)([(0,l.MZ)()],O.prototype,"fullWidth",null),(0,r._)([(0,l.MZ)()],O.prototype,"fullHeight",null),(0,r._)([(0,l.MZ)({readOnly:!0})],O.prototype,"_aspect",null),(0,r._)([(0,l.MZ)()],O.prototype,"padding",null),(0,r._)([(0,l.MZ)({readOnly:!0})],O.prototype,"projectionMatrix",null),(0,r._)([(0,l.MZ)({readOnly:!0})],O.prototype,"inverseProjectionMatrix",null),(0,r._)([(0,l.MZ)()],O.prototype,"fov",null),(0,r._)([(0,l.MZ)()],O.prototype,"fovX",null),(0,r._)([(0,l.MZ)()],O.prototype,"fovY",null),(0,r._)([(0,l.MZ)()],O.prototype,"viewInverseTransposeMatrix",null),(0,r._)([(0,l.MZ)({readOnly:!0})],O.prototype,"_projectionMatrixInternal",null),(0,r._)([(0,l.MZ)()],O.prototype,"relativeElevation",void 0),O=b=(0,r._)([(0,h.$)("esri.views.3d.webgl.RenderCamera")],O);const E=O,T=(0,m.vt)(),C=(0,u.vt)(),S=(0,g.vt)(),M=(0,g.vt)(),D=(0,a.r_)()},76718:(t,e,i)=>{i.d(e,{g:()=>h});var r=i(18690),s=(i(81806),i(76460)),n=i(78393),o=i(61678),a=i(93345);const l=()=>s.A.getLogger("esri.views.webgl.BufferObject");class h{static createIndex(t,e,i){return new h(t,a.NZ.ELEMENT_ARRAY_BUFFER,e,i)}static createVertex(t,e,i){return new h(t,a.NZ.ARRAY_BUFFER,e,i)}static createUniform(t,e,i){return new h(t,a.NZ.UNIFORM_BUFFER,e,i)}static createPixelPack(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a._U.STREAM_READ,i=arguments.length>2?arguments[2]:void 0;const r=new h(t,a.NZ.PIXEL_PACK_BUFFER,e);return i&&r.setSize(i),r}static createPixelUnpack(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a._U.STREAM_DRAW,i=arguments.length>2?arguments[2]:void 0;return new h(t,a.NZ.PIXEL_UNPACK_BUFFER,e,i)}static createTransformFeedback(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a._U.STATIC_DRAW,i=arguments.length>2?arguments[2]:void 0;const r=new h(t,a.NZ.TRANSFORM_FEEDBACK_BUFFER,e);return r.setSize(i),r}constructor(t,e,i,r){this._context=t,this.bufferType=e,this.usage=i,this._glName=null,this._size=-1,this._indexType=void 0,t.instanceCounter.increment(a.vt.BufferObject,this),this._glName=this._context.gl.createBuffer(),(0,o.Y2)(this._context.gl),r&&this.setData(r)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get usedMemory(){if(this.bufferType===a.NZ.ELEMENT_ARRAY_BUFFER){if(this._indexType===a.pe.UNSIGNED_INT)return 4*this._size;if(this._indexType===a.pe.UNSIGNED_SHORT)return 2*this._size}return this._size}get _isVAOAware(){return this.bufferType===a.NZ.ELEMENT_ARRAY_BUFFER||this.bufferType===a.NZ.ARRAY_BUFFER}dispose(){this._context?.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(a.vt.BufferObject,this),this._context=null):this._glName&&l().warn("Leaked WebGL buffer object")}setSize(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this.bufferType===a.NZ.ELEMENT_ARRAY_BUFFER&&null!=e)switch(this._indexType=e,e){case a.pe.UNSIGNED_SHORT:t*=2;break;case a.pe.UNSIGNED_INT:t*=4}this._setBufferData(t)}setData(t){if(!t)return;let e=t.byteLength;this.bufferType===a.NZ.ELEMENT_ARRAY_BUFFER&&((0,n.mg)(t)?this._indexType=a.pe.UNSIGNED_BYTE:(0,n.jq)(t)?(e/=2,this._indexType=a.pe.UNSIGNED_SHORT):(0,n.XJ)(t)&&(e/=4,this._indexType=a.pe.UNSIGNED_INT)),this._setBufferData(e,t)}_setBufferData(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._size=t;const i=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const r=this._context.gl;null!=e?r.bufferData(this.bufferType,e,this.usage):r.bufferData(this.bufferType,t,this.usage),(0,o.Y2)(r),this._isVAOAware&&this._context.bindVAO(i)}setSubData(t,e,i,r){if(!t)return;const s=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const{gl:n}=this._context;n.bufferSubData(this.bufferType,e*t.BYTES_PER_ELEMENT,t,i,r-i),(0,o.Y2)(n),this._isVAOAware&&this._context.bindVAO(s)}getSubData(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;if(i<0||s<0)return;const n=function(t){return(0,r.Xj)(t)}(t)?t.BYTES_PER_ELEMENT:1;if(n*((i??0)+(s??0))>t.byteLength)return;e+n*(s??0)>this.usedMemory&&l().warn("Potential problem getting subdata: requested data exceeds buffer size!");const o=this._context.gl;this.bufferType===a.NZ.TRANSFORM_FEEDBACK_BUFFER?(this._context.bindBuffer(this,a.NZ.TRANSFORM_FEEDBACK_BUFFER),o.getBufferSubData(a.NZ.TRANSFORM_FEEDBACK_BUFFER,e,t,i,s),this._context.unbindBuffer(a.NZ.TRANSFORM_FEEDBACK_BUFFER)):(this._context.bindBuffer(this,a.NZ.COPY_READ_BUFFER),o.getBufferSubData(a.NZ.COPY_READ_BUFFER,e,t,i,s),this._context.unbindBuffer(a.NZ.COPY_READ_BUFFER))}async getSubDataAsync(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0;await this._context.clientWaitAsync(),this.getSubData(t,e,i,r)}}},36911:(t,e,i)=>{i.d(e,{Z:()=>h});var r=i(76460),s=i(30726),n=i(78393),o=i(93345),a=i(27207);const l=()=>r.A.getLogger("esri.views.webgl.VertexArrayObject");let h=class{constructor(t,e,i,r){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;this._context=t,this._locations=e,this._layout=i,this._buffers=r,this._indexBuffer=s,this._glName=null,this._initialized=!1}get glName(){return this._glName}get context(){return this._context}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get byteSize(){return Array.from(this._buffers.values()).reduce(((t,e)=>t+e.usedMemory),null!=this._indexBuffer?this._indexBuffer.usedMemory:0)}get layout(){return this._layout}get locations(){return this._locations}get usedMemory(){return this.byteSize+(Object.keys(this._buffers).length+(this._indexBuffer?1:0))*n.zQ}dispose(){this._context?(this._context.getBoundVAO()===this&&this._context.bindVAO(null),this._buffers.forEach((t=>t.dispose())),this._buffers.clear(),this._indexBuffer=(0,s.WD)(this._indexBuffer),this.disposeVAOOnly()):(this._glName||Object.getOwnPropertyNames(this._buffers).length>0)&&l().warn("Leaked WebGL VAO")}disposeVAOOnly(){this._glName&&(this._context.gl.deleteVertexArray(this._glName),this._glName=null,this._context.instanceCounter.decrement(o.vt.VertexArrayObject,this)),this._context=null}initialize(){if(this._initialized)return;const{gl:t}=this._context,e=t.createVertexArray();t.bindVertexArray(e),this._bindLayout(),t.bindVertexArray(null),this._glName=e,this._context.instanceCounter.increment(o.vt.VertexArrayObject,this),this._initialized=!0}bind(){this.initialize(),this._context.gl.bindVertexArray(this.glName)}_bindLayout(){const{_buffers:t,_layout:e,_indexBuffer:i}=this;t||l().error("Vertex buffer dictionary is empty!");const r=this._context.gl;this._buffers.forEach(((t,i)=>{const r=e.get(i);r?(0,a.yu)(this._context,this._locations,t,r):l().error("Vertex element descriptor is empty!")})),null!=i&&r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,i.glName)}unbind(){this.initialize(),this._context.gl.bindVertexArray(null)}}},21812:(t,e,i)=>{i.d(e,{_:()=>r});class r{constructor(t,e,i,r,s){let n=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;this.name=t,this.count=e,this.type=i,this.offset=r,this.stride=s,this.normalized=n,this.divisor=o}}}}]);
//# sourceMappingURL=5727.5152697a.chunk.js.map